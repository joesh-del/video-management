{% extends "base.html" %}

{% block title %}AI Logs - MV Internal{% endblock %}

{% block content %}
<style>
    .filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .filter-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .filter-select {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--bg-secondary);
        color: var(--text);
        font-size: 0.875rem;
        min-width: 150px;
    }

    .log-row {
        cursor: pointer;
    }

    .log-row:hover {
        background: var(--border-light);
    }

    .prompt-preview {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: var(--text-secondary);
        font-size: 0.8125rem;
    }

    .response-preview {
        max-width: 400px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: var(--text-secondary);
        font-size: 0.8125rem;
    }

    .badge-error {
        background: #fee2e2;
        color: #991b1b;
    }

    .stats-row {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text);
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
    }

    .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
        padding: 1rem;
        border-top: 1px solid var(--border);
    }

    .pagination-info {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .pagination-buttons {
        display: flex;
        gap: 0.5rem;
    }

    /* Detail Modal */
    .detail-modal .modal {
        max-width: 800px;
    }

    .detail-section {
        margin-bottom: 1.5rem;
    }

    .detail-section:last-child {
        margin-bottom: 0;
    }

    .detail-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .detail-content {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1rem;
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
        font-size: 0.8125rem;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 300px;
        overflow-y: auto;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .detail-item-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .detail-item-value {
        font-weight: 500;
    }

    .timestamp {
        font-size: 0.8125rem;
        color: var(--text-secondary);
    }

    .model-badge {
        font-family: 'SF Mono', 'Monaco', monospace;
        font-size: 0.75rem;
    }
</style>

<div class="page-header">
    <div class="page-header-left">
        <h1>AI Logs</h1>
        <span class="page-subtitle">Quality monitoring for AI calls</span>
    </div>
    <button class="btn btn-secondary" onclick="loadLogs()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 4v6h6M23 20v-6h-6"/>
            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
        </svg>
        Refresh
    </button>
</div>

<!-- Stats -->
<div class="stats-row" id="statsRow">
    <div class="stat-item">
        <span class="stat-value" id="totalCalls">-</span>
        <span class="stat-label">Total Calls</span>
    </div>
    <div class="stat-item">
        <span class="stat-value" id="successRate">-</span>
        <span class="stat-label">Success Rate</span>
    </div>
    <div class="stat-item">
        <span class="stat-value" id="avgLatency">-</span>
        <span class="stat-label">Avg Latency</span>
    </div>
    <div class="stat-item">
        <span class="stat-value" id="totalTokens">-</span>
        <span class="stat-label">Total Tokens</span>
    </div>
</div>

<!-- Filters -->
<div class="filters">
    <div class="filter-group">
        <span class="filter-label">Request Type</span>
        <select class="filter-select" id="filterType" onchange="loadLogs()">
            <option value="">All Types</option>
            <option value="chat">Chat</option>
            <option value="regenerate_clip">Regenerate Clip</option>
            <option value="regenerate_record">Regenerate Record</option>
        </select>
    </div>
    <div class="filter-group">
        <span class="filter-label">Model</span>
        <select class="filter-select" id="filterModel" onchange="loadLogs()">
            <option value="">All Models</option>
            <option value="claude">Claude</option>
            <option value="gpt">GPT</option>
        </select>
    </div>
    <div class="filter-group">
        <span class="filter-label">Status</span>
        <select class="filter-select" id="filterSuccess" onchange="loadLogs()">
            <option value="">All</option>
            <option value="1">Success</option>
            <option value="0">Failed</option>
        </select>
    </div>
</div>

<!-- Logs Table -->
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Type</th>
                <th>Model</th>
                <th>Prompt</th>
                <th>Response</th>
                <th>Clips</th>
                <th>Latency</th>
                <th>Tokens</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="logsTable">
            <tr>
                <td colspan="9" class="empty-state">
                    <div class="spinner" style="margin: 2rem auto;"></div>
                </td>
            </tr>
        </tbody>
    </table>
    <div class="pagination">
        <span class="pagination-info" id="paginationInfo">Loading...</span>
        <div class="pagination-buttons">
            <button class="btn btn-secondary btn-sm" id="prevBtn" onclick="prevPage()" disabled>Previous</button>
            <button class="btn btn-secondary btn-sm" id="nextBtn" onclick="nextPage()" disabled>Next</button>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal-backdrop detail-modal" id="detailModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Log Details</h3>
            <button class="modal-close" onclick="closeDetailModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body" id="detailContent">
            <!-- Filled by JS -->
        </div>
    </div>
</div>

<script>
let currentOffset = 0;
const limit = 50;
let totalLogs = 0;

async function loadLogs() {
    const type = document.getElementById('filterType').value;
    const model = document.getElementById('filterModel').value;
    const success = document.getElementById('filterSuccess').value;

    const params = new URLSearchParams({
        limit: limit,
        offset: currentOffset
    });

    if (type) params.append('request_type', type);
    if (model) params.append('model', model);
    if (success !== '') params.append('success', success);

    try {
        const res = await fetch(`/api/ai-logs?${params}`);
        const data = await res.json();

        totalLogs = data.total;
        renderLogs(data.logs);
        updatePagination(data);
        updateStats(data.logs);
    } catch (e) {
        console.error('Failed to load logs:', e);
        document.getElementById('logsTable').innerHTML = `
            <tr><td colspan="9" class="empty-state">Failed to load logs</td></tr>
        `;
    }
}

function renderLogs(logs) {
    const tbody = document.getElementById('logsTable');

    if (!logs || logs.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="9" class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <h2>No logs found</h2>
                <p>AI logs will appear here after making requests</p>
            </td></tr>
        `;
        return;
    }

    tbody.innerHTML = logs.map(log => `
        <tr class="log-row" onclick="showDetail('${log.id}')">
            <td class="timestamp">${formatTime(log.created_at)}</td>
            <td><span class="badge badge-${getTypeBadge(log.request_type)}">${log.request_type}</span></td>
            <td><span class="badge badge-neutral model-badge">${log.model.split('-').slice(0, 2).join('-')}</span></td>
            <td class="prompt-preview">${escapeHtml(log.prompt || '-')}</td>
            <td class="response-preview">${escapeHtml(log.response || '-')}</td>
            <td>${log.clips_generated || 0}</td>
            <td>${log.latency_ms ? log.latency_ms + 'ms' : '-'}</td>
            <td>${formatTokens(log.input_tokens, log.output_tokens)}</td>
            <td>${log.success
                ? '<span class="badge badge-success"><span class="badge-dot"></span>OK</span>'
                : '<span class="badge badge-error"><span class="badge-dot"></span>Error</span>'}</td>
        </tr>
    `).join('');
}

function updateStats(logs) {
    // These are just for the current page - you could make a separate API call for overall stats
    const total = totalLogs;
    const successful = logs.filter(l => l.success).length;
    const avgLatency = logs.length > 0
        ? Math.round(logs.filter(l => l.latency_ms).reduce((sum, l) => sum + l.latency_ms, 0) / logs.filter(l => l.latency_ms).length)
        : 0;
    const totalTokensUsed = logs.reduce((sum, l) => sum + (l.input_tokens || 0) + (l.output_tokens || 0), 0);

    document.getElementById('totalCalls').textContent = total.toLocaleString();
    document.getElementById('successRate').textContent = logs.length > 0 ? Math.round(successful / logs.length * 100) + '%' : '-';
    document.getElementById('avgLatency').textContent = avgLatency ? avgLatency + 'ms' : '-';
    document.getElementById('totalTokens').textContent = totalTokensUsed.toLocaleString();
}

function updatePagination(data) {
    const start = data.offset + 1;
    const end = Math.min(data.offset + data.logs.length, data.total);
    document.getElementById('paginationInfo').textContent = `Showing ${start}-${end} of ${data.total} logs`;

    document.getElementById('prevBtn').disabled = currentOffset === 0;
    document.getElementById('nextBtn').disabled = currentOffset + limit >= data.total;
}

function prevPage() {
    if (currentOffset > 0) {
        currentOffset -= limit;
        loadLogs();
    }
}

function nextPage() {
    if (currentOffset + limit < totalLogs) {
        currentOffset += limit;
        loadLogs();
    }
}

async function showDetail(logId) {
    try {
        const res = await fetch(`/api/ai-logs/${logId}`);
        const log = await res.json();

        document.getElementById('detailContent').innerHTML = `
            <div class="detail-grid">
                <div class="detail-item">
                    <span class="detail-item-label">Request Type</span>
                    <span class="detail-item-value">${log.request_type}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-item-label">Model</span>
                    <span class="detail-item-value">${log.model}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-item-label">Status</span>
                    <span class="detail-item-value">${log.success ? 'Success' : 'Failed'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-item-label">Latency</span>
                    <span class="detail-item-value">${log.latency_ms ? log.latency_ms + 'ms' : '-'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-item-label">Input Tokens</span>
                    <span class="detail-item-value">${log.input_tokens?.toLocaleString() || '-'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-item-label">Output Tokens</span>
                    <span class="detail-item-value">${log.output_tokens?.toLocaleString() || '-'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-item-label">Clips Generated</span>
                    <span class="detail-item-value">${log.clips_generated || 0}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-item-label">Time</span>
                    <span class="detail-item-value">${formatTime(log.created_at)}</span>
                </div>
            </div>

            ${log.error_message ? `
            <div class="detail-section" style="margin-top: 1.5rem;">
                <div class="detail-label">Error Message</div>
                <div class="detail-content" style="background: #fee2e2; border-color: #fecaca;">${escapeHtml(log.error_message)}</div>
            </div>
            ` : ''}

            <div class="detail-section" style="margin-top: 1.5rem;">
                <div class="detail-label">Prompt</div>
                <div class="detail-content">${escapeHtml(log.prompt || 'No prompt recorded')}</div>
            </div>

            ${log.context_summary ? `
            <div class="detail-section">
                <div class="detail-label">Context Summary</div>
                <div class="detail-content">${escapeHtml(log.context_summary)}</div>
            </div>
            ` : ''}

            <div class="detail-section">
                <div class="detail-label">Response</div>
                <div class="detail-content">${escapeHtml(log.response || 'No response recorded')}</div>
            </div>

            ${log.response_json ? `
            <div class="detail-section">
                <div class="detail-label">Response JSON</div>
                <div class="detail-content">${escapeHtml(JSON.stringify(log.response_json, null, 2))}</div>
            </div>
            ` : ''}
        `;

        document.getElementById('detailModal').classList.add('show');
    } catch (e) {
        console.error('Failed to load log detail:', e);
        showToast('Failed to load log details', 'error');
    }
}

function closeDetailModal() {
    document.getElementById('detailModal').classList.remove('show');
}

function formatTime(isoString) {
    if (!isoString) return '-';
    const date = new Date(isoString);
    return date.toLocaleString();
}

function formatTokens(input, output) {
    if (!input && !output) return '-';
    const total = (input || 0) + (output || 0);
    return total.toLocaleString();
}

function getTypeBadge(type) {
    switch (type) {
        case 'chat': return 'info';
        case 'regenerate_clip': return 'purple';
        case 'regenerate_record': return 'warning';
        default: return 'neutral';
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Close modal on backdrop click
document.getElementById('detailModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDetailModal();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeDetailModal();
    }
});

// Load logs on page load
loadLogs();
</script>
{% endblock %}
